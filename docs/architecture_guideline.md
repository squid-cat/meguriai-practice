# アーキテクチャ設計ドキュメント

## 基本方針

このドキュメントは、与えられた要件に対してどのようなアーキテクチャで実現するかを示すガイドラインです。

**重要**: 記載されているすべての技術を使用する必要はありません。**要件に応じて必要な技術のみを選択**して使用してください。このドキュメントは技術選択の選択肢を提供するものであり、すべてを実装することを前提としていません。

## 基本構成

### システム構成
```
Next.js Frontend ←→ Hono API Backend ←→ PostgreSQL Database
```

### 技術スタック

#### フロントエンド
- **Framework**: Next.js
- **Language**: TypeScript

#### バックエンドAPI
- **Framework**: Hono
- **Language**: TypeScript

#### データベース
- **Database**: PostgreSQL

## リアルタイム通信

### 基本方針
リアルタイム通信が必要な場合は**Firestore**を使用する。

### 実装詳細
- **Hono APIによるWebSocket**: 使用しない
- **Firestore**: リアルタイムデータベースとして使用
- **アクセス方法**: フロントエンドとバックエンドの両方から接続可能
    - **フロントエンド**: ブラウザから直接Firestoreにアクセス
    - **バックエンド**: Hono APIからFirestore Admin SDKでアクセス
- **セキュリティルール**: Firestoreには適切なセキュリティルールを設定する

## 認証システム

### 基本方針
認証を実装する場合は**Firebase Authentication**を使用する。

### 認証プロバイダー
- **Google認証**: 主要な認証方式
- **匿名認証**: ゲストユーザー対応

### 認証フロー

#### 1. フロントエンド認証
- フロントエンドでFirebase Authenticationを使用して認証を行う
- ログインボタン押下後、Firebase Authenticationによる認証フローを開始

#### 2. ユーザー情報管理
- **DBテーブル**: ユーザー情報を格納するテーブルを作成
- **格納データ**: ユーザーIDとFirebase AuthenticationのUIDを格納
- **初回ログイン**: まだユーザーがDBに作成されていない場合は、DBにユーザーを追加

#### 3. 認証状態管理
- **ログイン後**: ログアウトボタンを押すまでサインイン状態を維持
- **セッション管理**: Firebase Authenticationのセッション機能を使用

#### 4. バックエンド認証
- **フロントエンド→バックエンド**: Firebase AuthenticationのIDトークンをAuthorization Bearerヘッダで送信
    - `Authorization: Bearer <IDトークン>`
- **バックエンド検証**: IDトークンを検証することでリクエストを認証

### 認証フロー図
```
1. ユーザーがログインボタンをクリック
   ↓
2. Firebase Authentication認証フロー開始
   ↓
3. 認証成功 → IDトークン取得
   ↓
4. DBにユーザーが存在するかチェック
   ↓
5. 存在しない場合 → DBにユーザー作成
   ↓
6. サインイン状態を維持
   ↓
7. API呼び出し時はIDトークンをAuthorization Bearerヘッダで送信
   ↓
8. バックエンドでIDトークンを検証
```

## ファイルストレージ

### 基本方針
ファイルアップロード機能が必要な場合は**Cloud Storage for Firebase**を使用する。

### 実装詳細
- **ストレージサービス**: Cloud Storage for Firebase
- **アップロード方式**: バックエンドAPIを経由してCloud Storageにアップロード
- **アクセス方法**: バックエンドからFirebase Admin SDKでアクセス
- **セキュリティルール**: Cloud Storageには適切なセキュリティルールを設定する
- **ファイル管理**: アップロードされたファイルのメタデータはPostgreSQLで管理

### ファイルアップロードフロー
```
1. ユーザーがファイルを選択
   ↓
2. フロントエンドからバックエンドAPIにファイルを送信
   ↓
3. バックエンドでファイル検証・処理を実行
   ↓
4. バックエンドからCloud Storageにアップロード
   ↓
5. アップロード成功 → ダウンロードURLを取得
   ↓
6. ファイルのメタデータ（URL、ファイル名、サイズ等）をPostgreSQLに保存
   ↓
7. フロントエンドにアップロード結果を返却
```

## 開発時の注意事項

### セキュリティ
- **Firestoreセキュリティルール**: 適切なアクセス制御を設定
- **Cloud Storageセキュリティルール**: ファイルアクセスの適切な制御を設定
- **IDトークン検証**: バックエンドで必ずFirebase IDトークンを検証

### データ管理
- **メインデータ**: PostgreSQLで管理
- **リアルタイムデータ**: Firestoreで管理
- **認証データ**: Firebase Authenticationで管理
- **ファイルデータ**: Cloud Storage for Firebaseで管理、メタデータはPostgreSQLで管理

---

**基本方針**: シンプルかつセキュアなアーキテクチャで効率的な開発を目指す
