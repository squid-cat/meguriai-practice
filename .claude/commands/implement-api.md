---
description: APIの実装を行います
---

# API実装

前工程で作成したAPI設計とスタブ実装、各設計書を元に、実際の機能を実装します。

## 参照する設計書

- 機能設計書: `packages/documents/docs/designs/feature-design.md`
- API設計書: `packages/documents/docs/designs/api-design.md`
- OpenAPI仕様書: `packages/api/openapi.json`
- 既存のスタブ実装: `packages/api/src/routes/[機能名]/`

**重要**: API設計書とOpenAPI仕様書の内容が矛盾する場合は、OpenAPI仕様書（`packages/api/openapi.json`）の内容を正として実装します。

## 実装内容

`docs/api_development_guideline.md` に従って、機能設計書とAPI設計書に基づき以下の実装を行います：

### 1. 設計書の確認と実装計画

- **機能設計書の確認**
  - `packages/documents/docs/designs/feature-design.md` から対象機能の要件を確認
  - フロントエンド/バックエンド分担、ビジネスルール、セキュリティ要件を把握
  - パフォーマンス要件と制約事項の確認

- **API設計書とOpenAPI仕様の確認**
  - `packages/documents/docs/designs/api-design.md` と `packages/api/openapi.json` の内容を比較
  - 矛盾がある場合は `openapi.json` を正として実装方針を決定
  - エンドポイント、リクエスト/レスポンス形式、エラーハンドリングの確認

### 2. ビジネスロジックの実装

- **サービス層の実装**
  - `packages/api/src/services/[機能名]/` にビジネスロジックを実装
  - 機能設計書に定義されたビジネスルールに準拠
  - 単一責任の原則に従い、各サービスは特定の責務のみを持つ
  - テスト可能な設計（依存性注入等）

- **データアクセス層の実装**
  - Prismaを使用したデータベースアクセス
  - 必要に応じてリポジトリパターンの適用
  - トランザクション処理の実装

### 3. エラーハンドリング

- **カスタムエラークラスの実装**
  - ビジネスロジックエラーの定義
  - HTTPステータスコードへのマッピング
  
- **エラーミドルウェアの実装**
  - 統一的なエラーレスポンス形式
  - ログ出力の実装

### 4. バリデーションとセキュリティ

- **入力値検証**
  - zod-openapiで定義したスキーマによる自動バリデーション
  - 機能設計書に定義されたビジネスルールに基づく追加バリデーション
  
- **セキュリティ対策**
  - SQLインジェクション対策（Prismaによる自動対策）
  - 機能設計書に定義された認証・認可の実装（必要な場合）
  - レート制限の実装（必要な場合）

### 5. パフォーマンス最適化

- **データベースクエリの最適化**
  - N+1問題の解決
  - 適切なインデックスの設定
  - クエリの効率化

### 6. テストの実装

- **単体テスト**
  - サービス層のテスト
  - ユーティリティ関数のテスト
  
- **統合テスト**
  - APIエンドポイントのテスト
  - データベースを含むテスト

### 7. ドキュメントの更新

- API実装の詳細をドキュメントに反映
- 使用例やサンプルコードの追加
- 注意事項や制限事項の記載

## 実装ファイル構成

```
packages/api/src/
├── routes/[機能名]/
│   ├── index.ts        # ルート定義（既存）
│   ├── schemas.ts      # スキーマ定義（既存）
│   └── handlers.ts     # ハンドラー実装（更新）
├── services/[機能名]/
│   ├── index.ts        # サービスのエクスポート
│   └── *.service.ts   # 各サービスの実装
├── repositories/[機能名]/
│   └── *.repository.ts # リポジトリ実装（必要な場合）
└── utils/
    └── errors.ts       # カスタムエラークラス
```

実装完了後、すべてのAPIが設計通りに動作することを確認します。
