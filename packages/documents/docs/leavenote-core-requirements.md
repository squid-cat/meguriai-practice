# LeaveNote コア機能 要件定義書

## 概要

旅行や長期外出前の"やり残し"や"もしものとき"の不安を整理・共有するWeb完結型の安心ノートサービス「LeaveNote（リーブノート）」のコア機能に関する要件定義書です。

## ユーザストーリー

### ストーリー1: 旅行前の不安解消

- **である** 旅行予定者（30-40代共働き家庭、20-30代一人暮らし） **として**
- **私は** 旅行前にやるべきことや緊急時の対応を整理し、信頼できる人と共有したい **をしたい**
- **そうすることで** 「家族や友人が困らないだろうか」「やり残しはないかな」という不安を解消し、安心して旅行を楽しめる

### ストーリー2: 情報の簡単共有

- **である** 旅行者 **として**
- **私は** 複雑な手順なしに、Webブラウザだけで必要な情報を整理・共有したい **をしたい**
- **そうすることで** 紙のメモやLINEでのバラバラな情報伝達から解放され、一箇所で管理できる

### ストーリー3: 旅行後の改善

- **である** 旅行経験者 **として**
- **私は** 旅行後に「良かったこと」「足りなかったこと」を振り返り、次回に活かしたい **をしたい**
- **そうすることで** 毎回同じ失敗を繰り返すことなく、より良い旅行準備ができるようになる

## 機能要件（EARS記法）

### 通常要件（SHALL）

#### 認証・アカウント管理
- REQ-001: システムはFirebase Authenticationを使用したGoogle認証機能を提供しなければならない
- REQ-002: システムは匿名認証機能を提供しなければならない
- REQ-003: システムはユーザー情報をPostgreSQLで管理し、Firebase UIDと連携しなければならない

#### ノート管理機能
- REQ-101: システムはユーザーがLeaveNoteを新規作成できる機能を提供しなければならない
- REQ-102: システムはノートの編集機能を提供しなければならない
- REQ-103: システムはノートの削除機能を提供しなければならない
- REQ-104: システムはユーザーのノート一覧をダッシュボードに表示しなければならない
- REQ-105: システムは個別ノートの詳細表示機能を提供しなければならない
- REQ-106: システムはノートのステータス（下書き/アクティブ/完了）を管理しなければならない

#### チェックリスト機能
- REQ-201: システムはチェックリスト項目の追加・削除機能を提供しなければならない
- REQ-202: システムは各項目の完了/未完了状態を管理しなければならない
- REQ-203: システースはチェックリストの完了率を計算・表示しなければならない
- REQ-204: システムはデフォルトのチェック項目（エアコンOFF、ガス元栓確認、ゴミ出し）を提供しなければならない

#### 緊急連絡先管理機能
- REQ-301: システムは複数の緊急連絡先を登録・管理する機能を提供しなければならない
- REQ-302: システムは連絡先情報（名前、続柄、電話、メール）を保存しなければならない
- REQ-303: システムは緊急連絡先データを暗号化して保存しなければならない
- REQ-304: システムは電話・メールアプリとの連携（tel:/mailto:リンク）を提供しなければならない

#### お願いメモ機能
- REQ-401: システムは依頼事項の登録・管理機能を提供しなければならない
- REQ-402: システムは依頼事項に対する優先度設定（高/中/低）機能を提供しなければならない
- REQ-403: システムは優先度別の色分け表示（高=赤、中=青、低=グレー）を行わなければならない
- REQ-404: システムは依頼内容を500文字以内で制限しなければならない

#### 共有機能
- REQ-501: システムはノートの共有URL生成機能を提供しなければならない
- REQ-502: システムは共有URLでの読み取り専用アクセスを提供しなければならない
- REQ-503: システムは共有トークンにUUID等を使用し推測困難性を確保しなければならない
- REQ-504: システムは共有アクセスのログ記録機能を提供しなければならない

### 条件付き要件（WHEN/IF-THEN）

#### 認証制御
- REQ-601: ユーザーが未認証の場合、システムは認証画面にリダイレクトしなければならない
- REQ-602: ユーザーが初回認証の場合、システムは新規ユーザーをデータベースに作成しなければならない
- REQ-603: 認証トークンが無効な場合、システムは再認証を要求しなければならない

#### ノート操作制御
- REQ-701: ノートがアクティブ状態の場合、システムは削除前に確認ダイアログを表示しなければならない
- REQ-702: 必須項目（タイトル、行き先、日程）が未入力の場合、システムは保存を拒否しなければならない
- REQ-703: ユーザーが他人のノートにアクセスしようとした場合、システムはアクセスを拒否しなければならない

#### チェックリスト制御
- REQ-801: チェックリスト項目が全て完了した場合、システムは完了率100%を表示しなければならない
- REQ-802: チェック項目が1つも存在しない場合、システムはデフォルト項目を表示しなければならない

#### 緊急連絡先制御
- REQ-901: 電話番号が不正な形式の場合、システムはバリデーションエラーを表示しなければならない
- REQ-902: メールアドレスが不正な形式の場合、システムはバリデーションエラーを表示しなければならない
- REQ-903: 緊急連絡先が0件になる削除操作の場合、システムは操作を拒否しなければならない

#### 共有制御
- REQ-1001: 無効な共有URLでアクセスした場合、システムは404エラーを表示しなければならない
- REQ-1002: 共有が停止されたノートにアクセスした場合、システムはアクセス拒否メッセージを表示しなければならない

### 状態要件（WHERE）

#### 振り返り機能アクセス制御
- REQ-1101: ノートのステータスが「完了」状態にある場合、システムは振り返り機能へのアクセスを許可しなければならない
- REQ-1102: ノートのステータスが「下書き」または「アクティブ」状態にある場合、システムは振り返り機能へのアクセスを制限しなければならない

#### テンプレート作成制御
- REQ-1201: 振り返りが完了した状態にある場合、システムはテンプレート作成機能を有効化しなければならない

### オプション要件（MAY）

#### 将来拡張機能
- REQ-1301: システムはパスワード付き共有機能を提供してもよい
- REQ-1302: システムは共有期限設定機能を提供してもよい
- REQ-1303: システムはPDF出力機能を提供してもよい
- REQ-1304: システムは画像添付機能を提供してもよい
- REQ-1305: システムはチーム機能（家族アカウント）を提供してもよい
- REQ-1306: システムは通知機能（リマインダー）を提供してもよい

### 制約要件（MUST）

#### 技術制約
- REQ-1401: システムはNext.js 15.4.4以上を使用しなければならない
- REQ-1402: システムはFirebase Authenticationを認証方式として使用しなければならない
- REQ-1403: システムはPostgreSQLをデータベースとして使用しなければならない
- REQ-1404: システムはHTTPS通信を強制しなければならない
- REQ-1405: システムはOpenAPI 3.0によるAPI設計に従わなければならない

#### データ制約
- REQ-1501: システムはノート1件あたりのデータサイズを最大10KBに制限しなければならない
- REQ-1502: システムは個人情報を暗号化して保存しなければならない
- REQ-1503: システムはXSS・CSRF対策を実装しなければならない

#### 言語制約
- REQ-1601: システムのすべてのユーザー向けテキスト、メッセージ、エラー表示は日本語で表示しなければならない

## 非機能要件

### パフォーマンス

- NFR-001: システムはページ初期表示を3秒以内に完了しなければならない
- NFR-002: システムはデータ更新処理を1秒以内に完了しなければならない
- NFR-003: システムは検索機能を2秒以内に完了しなければならない
- NFR-004: システムは50ユーザーの同時アクセスに対応しなければならない

### セキュリティ

- NFR-101: システムは個人情報を暗号化して保存しなければならない
- NFR-102: システムはHTTPS通信を強制しなければならない
- NFR-103: システムはXSS・CSRF攻撃に対する対策を実装しなければならない
- NFR-104: システムは正規の共有URL以外のアクセスを拒否しなければならない

### ユーザビリティ

- NFR-201: システムはモバイルファーストのレスポンシブデザインを提供しなければならない
- NFR-202: システムは一貫したUIデザインパターン（shadcn/ui）を使用しなければならない
- NFR-203: システムは視覚的に分かりやすい進捗表示を提供しなければならない
- NFR-204: システムはアクセシビリティ基準（WCAG 2.1 AA）に準拠しなければならない

### 可用性

- NFR-301: システムは99%以上の稼働率を維持しなければならない
- NFR-302: システムは計画的メンテナンス以外でのダウンタイムを月1時間以内に抑制しなければならない

## Edgeケース

### エラー処理

- EDGE-001: ネットワーク接続エラー時は適切なエラーメッセージと再試行オプションを表示する
- EDGE-002: データベース接続エラー時は一時的な障害メッセージを表示し、自動復旧を試行する
- EDGE-003: 認証トークン期限切れ時は自動的に再認証フローに誘導する
- EDGE-004: 不正なAPIリクエスト時は適切なHTTPステータスコードとエラーメッセージを返す

### 境界値

- EDGE-101: チェックリスト項目数が0件の場合はデフォルト項目を表示する
- EDGE-102: 緊急連絡先が上限数（例：10件）に達した場合は追加を制限する
- EDGE-103: お願いメモの文字数が500文字を超過する場合は入力を制限する
- EDGE-104: 同時編集時はデータの整合性を保つため最後の更新を優先する

### データ整合性

- EDGE-201: ユーザー削除時は関連するノートデータを全て削除する（カスケード削除）
- EDGE-202: 共有停止時は共有URLへのアクセスを即座に無効化する
- EDGE-203: ノート削除時は関連する振り返りデータとテンプレートも削除する

### セキュリティ境界

- EDGE-301: 異常な頻度のAPI呼び出しは Rate Limiting で制限する
- EDGE-302: 不正な共有URL パターンへのアクセスは即座に拒否する
- EDGE-303: セッション乗っ取り試行を検出した場合は該当セッションを無効化する

## 受け入れ基準

### 機能テスト

- [ ] Google認証でログイン・ログアウトが正常に動作する
- [ ] ノートのCRUD操作（作成・読込・更新・削除）が正常に動作する
- [ ] チェックリストの項目追加・削除・完了状態変更が正常に動作する
- [ ] 緊急連絡先の登録・編集・削除が正常に動作する
- [ ] お願いメモの登録・優先度設定・表示が正常に動作する
- [ ] 共有URL生成と共有ページでの閲覧が正常に動作する
- [ ] 旅行完了後の振り返り機能が正常に動作する
- [ ] 振り返り後のテンプレート作成が正常に動作する

### セキュリティテスト

- [ ] 未認証ユーザーは保護されたページにアクセスできない
- [ ] 他ユーザーのノートに不正アクセスできない
- [ ] 緊急連絡先データが暗号化保存されている
- [ ] XSS攻撃に対する適切な防御が機能している
- [ ] CSRF攻撃に対する適切な防御が機能している

### パフォーマンステスト

- [ ] ページ初期表示が3秒以内に完了する
- [ ] データ更新処理が1秒以内に完了する
- [ ] 50ユーザー同時アクセス時に正常に動作する
- [ ] モバイルデバイスでも快適に操作できる

### ユーザビリティテスト

- [ ] 各種操作がユーザーにとって直感的である
- [ ] エラーメッセージが分かりやすく表示される
- [ ] レスポンシブデザインが適切に機能している
- [ ] アクセシビリティ基準を満たしている

## 非機能テスト

- [ ] データベース接続障害時の適切なエラーハンドリング
- [ ] 大量データ処理時のパフォーマンス劣化がない
- [ ] セキュリティ脆弱性スキャンをパスしている
- [ ] コードカバレッジが80%以上である

---

**作成日**: 2025-08-03  
**バージョン**: 1.0  
**作成者**: システム要件定義  
**承認者**: プロダクトオーナー  

このドキュメントはLeaveNoteサービスのコア機能実装における開発・テストの指針として使用される。