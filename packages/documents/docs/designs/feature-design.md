# 機能設計書

## 概要
- **設計方針**: フロントエンドデザインとサービス設計書に基づく機能設計
- **アーキテクチャ準拠**: docs/architecture_guideline.md に基づく設計
- **API準拠**: docs/api_development_guideline.md に基づく設計

## システム全体像

LeaveNote（リーブノート）は、旅行前の"やり残し"や"もしものとき"の不安を整理・共有するWeb完結型の安心ノートサービスです。

### 主要機能
1. **ノート管理機能** - LeaveNoteの作成・編集・削除・一覧表示
2. **チェックリスト機能** - 出発前のやることリスト管理
3. **緊急連絡先管理** - 万が一の時の連絡先情報
4. **お願いメモ機能** - 家族や隣人への依頼事項
5. **共有機能** - URLによるノート共有
6. **振り返り機能** - 旅行後の改善点記録
7. **テンプレート機能** - 次回用のテンプレート保存

## 認証・認可設計

### 認証の必要性判定
**結論**: 認証機能を実装する

**理由**:
- 個人の旅行情報、緊急連絡先などの機密情報を扱う
- ユーザー毎のデータ管理が必要
- 共有機能でアクセス制御が必要
- 振り返りやテンプレート保存でデータの永続化が必要

### 認証・認可方式
- **方式**: Firebase Authentication + IDトークン
- **プロバイダー**: Google認証、匿名認証
- **フロー**: docs/architecture_guideline.md に準拠

#### 認証フロー
1. **フロントエンド認証**: Firebase Authenticationによる認証
2. **ユーザー管理**: PostgreSQLでユーザー情報管理（Firebase UID連携）
3. **API認証**: IDトークンをBearerヘッダで送信
4. **バックエンド検証**: Firebase Admin SDKでトークン検証

#### 権限管理
- **ノート作成者**: 自分のノートに対するすべての権限
- **共有先ユーザー**: 読み取り専用アクセス
- **未認証ユーザー**: 共有URLでの限定的な閲覧（将来機能）

## ノート管理機能

### 機能概要
ユーザーが旅行用のLeaveNoteを作成・管理する中核機能

### 機能詳細
- **ノート作成**: 基本情報入力によるノート作成
- **ノート編集**: 既存ノートの情報更新
- **ノート削除**: 不要になったノートの削除
- **ノート一覧**: ダッシュボードでの一覧表示
- **ノート詳細**: 個別ノートの詳細表示

### フロントエンド/バックエンド分担
- **フロントエンド**: 
  - CRUD画面の提供
  - リアルタイムバリデーション
  - ステータス表示（下書き/アクティブ/完了）
  - 検索・フィルタリング機能
- **バックエンド**: 
  - データ永続化
  - ビジネスロジック（ステータス制御）
  - API提供
  - データ整合性保証

### ビジネスルール
- **ステータス管理**: draft → active → completed
- **削除制御**: アクティブ状態での削除時は確認必須
- **データ検証**: 必須項目（タイトル、行き先、日程）の検証

## チェックリスト機能

### 機能概要
出発前にやるべきことをリスト化し、進捗を管理する機能

### 機能詳細
- **項目追加/削除**: チェックリスト項目の管理
- **完了状態管理**: チェックボックスによる完了/未完了
- **進捗表示**: 完了率の可視化
- **テンプレート**: よく使われる項目の事前定義

### フロントエンド/バックエンド分担
- **フロントエンド**: 
  - 動的な項目追加/削除UI
  - チェック状態のリアルタイム更新
  - 進捗バーによる視覚化
- **バックエンド**: 
  - チェック状態の永続化
  - 進捗率計算
  - テンプレートデータ管理

### ビジネスルール
- **デフォルト項目**: 「エアコンOFF」「ガス元栓確認」「ゴミ出し」
- **完了後の編集**: 完了済みタスクも編集可能
- **削除制限**: なし（自由に追加/削除可能）

## 緊急連絡先管理機能

### 機能概要
万が一の時の連絡先を管理し、共有先に提供する機能

### 機能詳細
- **連絡先登録**: 名前、続柄、電話、メールの管理
- **複数連絡先**: 複数の緊急連絡先を登録可能
- **連絡先表示**: 共有ページでの見やすい表示
- **クリック連携**: 電話・メールアプリとの連携

### フロントエンド/バックエンド分担
- **フロントエンド**: 
  - 連絡先入力フォーム
  - 動的な連絡先追加/削除
  - tel:/mailto:リンク生成
- **バックエンド**: 
  - 連絡先データの暗号化保存
  - バリデーション（電話番号・メール形式）
  - アクセス制御

### セキュリティ要件
- **データ暗号化**: 個人情報のため暗号化保存
- **アクセス制御**: ノート作成者と共有先のみアクセス可能
- **バリデーション**: 電話番号・メールアドレスの形式検証

### ビジネスルール
- **必須情報**: 名前、続柄は必須
- **連絡手段**: 電話またはメールのいずれか必須
- **削除制限**: 最低1件は必須

## お願いメモ機能

### 機能概要
家族や隣人への依頼事項を整理し、優先度付きで管理する機能

### 機能詳細
- **依頼事項登録**: 依頼先、内容、優先度の管理
- **優先度設定**: 高/中/低の3段階
- **複数依頼**: 複数人への複数依頼を管理
- **共有表示**: 共有ページでの依頼内容表示

### フロントエンド/バックエンド分担
- **フロントエンド**: 
  - 依頼事項入力フォーム
  - 優先度別表示
  - 依頼先別グループ表示
- **バックエンド**: 
  - 依頼データの保存
  - 優先度によるソート
  - 共有データのフィルタリング

### ビジネスルール
- **優先度表示**: 高=赤、中=青、低=グレーで色分け
- **文字数制限**: 依頼内容は500文字以内
- **削除制限**: なし（自由に追加/削除可能）

## 共有機能

### 機能概要
作成したLeaveNoteをURLで他者と共有する機能

### 機能詳細
- **共有URL生成**: 一意のURLによる共有
- **読み取り専用**: 共有先は閲覧のみ可能
- **期限設定**: 共有期限の設定（将来機能）
- **パスワード保護**: 共有URLのパスワード保護（将来機能）

### フロントエンド/バックエンド分担
- **フロントエンド**: 
  - 共有URL表示・コピー機能
  - 共有専用ページの表示
  - 共有状態の視覚化
- **バックエンド**: 
  - 共有トークン生成
  - アクセス制御
  - 共有ログ記録

### セキュリティ要件
- **URL推測困難性**: UUID等での一意性確保
- **アクセス制御**: 正規の共有URL以外はアクセス拒否
- **ログ記録**: 共有アクセスの記録

### ビジネスルール
- **共有状態**: 作成者がいつでも共有停止可能
- **データ制限**: 共有先では機密度の高い情報は制限表示
- **有効期限**: デフォルトは無期限、設定により期限付き

## 振り返り機能

### 機能概要
旅行後に改善点を記録し、次回の旅行に活かす機能

### 機能詳細
- **振り返り記録**: 良かった点、改善点の記録
- **タスク分析**: 完了/未完了タスクの分析
- **改善提案**: 次回への提案生成
- **テンプレート化**: 振り返りを元にしたテンプレート作成

### フロントエンド/バックエンド分担
- **フロントエンド**: 
  - 振り返り入力フォーム
  - 統計データの可視化
  - テンプレート作成UI
- **バックエンド**: 
  - 振り返りデータの保存
  - 統計データ計算
  - テンプレート生成ロジック

### ビジネスルール
- **実施タイミング**: 旅行完了後のみ利用可能
- **データ活用**: 振り返り内容を次回テンプレートに反映
- **プライバシー**: 振り返り内容は本人のみ閲覧可能

## テンプレート機能

### 機能概要
過去の経験を元にした次回用のテンプレートを管理する機能

### 機能詳細
- **テンプレート保存**: 過去のノートをテンプレート化
- **テンプレート適用**: 新規ノート作成時のテンプレート利用
- **テンプレート編集**: 保存済みテンプレートの修正
- **カテゴリ分け**: 旅行種別によるテンプレート分類

### フロントエンド/バックエンド分担
- **フロントエンド**: 
  - テンプレート選択UI
  - テンプレート編集画面
  - カテゴリ別表示
- **バックエンド**: 
  - テンプレートデータ管理
  - ノートからのテンプレート生成
  - カテゴリ管理

### ビジネスルール
- **作成元**: 振り返り完了済みノートからのみ作成可能
- **適用制限**: 同一ユーザーのテンプレートのみ利用可能
- **更新権限**: テンプレート作成者のみ編集可能

## データフロー設計

### ユーザー登録・認証フロー
```
1. Google認証でサインイン
2. Firebase IDトークン取得
3. バックエンドでユーザー存在確認
4. 存在しない場合はユーザー作成
5. セッション開始
```

### ノート作成フロー
```
1. 認証済みユーザーがノート作成画面アクセス
2. 基本情報入力
3. チェックリスト項目追加
4. 緊急連絡先入力
5. お願いメモ入力
6. 下書き保存 or 作成完了
7. データベースに保存
```

### 共有フロー
```
1. ノート作成者が共有ボタンクリック
2. 共有トークン生成
3. 共有URL生成・表示
4. 共有先ユーザーがURL訪問
5. 共有ページで閲覧
```

### 振り返りフロー
```
1. 旅行完了後、振り返りページアクセス
2. 完了タスクの自動分析表示
3. 振り返り内容入力
4. テンプレート作成選択
5. 次回用テンプレート生成
```

## パフォーマンス要件

### レスポンス時間
- ページ初期表示: 3秒以内
- データ更新: 1秒以内
- 検索機能: 2秒以内

### 同時アクセス
- 想定同時ユーザー数: 50ユーザー
- 共有ページアクセス: 制限なし

### データ容量
- ノート1件あたり: 最大10KB
- 画像アップロード: 将来機能として検討

## セキュリティ要件

### データ保護
- 個人情報の暗号化保存
- HTTPS通信の強制
- XSS・CSRF対策

### アクセス制御
- ユーザー認証必須
- ノート作成者のみ編集可能
- 共有URLでの限定アクセス

### プライバシー
- 振り返り内容は本人のみ閲覧
- 緊急連絡先は最小限の表示
- データ削除時の完全消去

## 将来拡張機能

### Phase 2 機能
- パスワード付き共有
- 共有期限設定
- PDF出力機能
- 画像添付機能

### Phase 3 機能
- チーム機能（家族アカウント）
- 通知機能（リマインダー）
- 位置情報連携
- 外部カレンダー連携